{% extends "payments/base.html" %}

{% block title %}Pay your order{% endblock %}

{% block content %}
  <h1>Order summary</h1>
  <ul>
    {% for item in order.items.all %}
      <li>
        <p>Product: {{ item.item.name }}</p>
        <p>Price: {{ item.price }} {{ item.item.currency }}</p>
        <p>Quantity: {{ item.quantity }}</p>
        <p>Total: {{ item.get_cost }} ₽</p>
      </li>
    {% endfor %}
  </ul>
    {% if order.tax.exists %}
          <p><b>Taxes:</b></p>
            <p>{% for tax in order.tax.all %}
               {{ tax.name }} ({{ tax.rate }}%): ₽{{ order.get_total_tax|floatformat:2 }}
               {% endfor %}</p>
      {% endif %}

      {% if order.coupon %}
          <p><b>Discount:</b></p>
            <p>"{{ order.coupon.code }}" coupon
               ({{ order.discount }}% off)
               – ₽{{ order.get_discount|floatformat:2 }}</p>
      {% endif %}

  <b>Overall:</b> {{ order.get_total_cost|floatformat:2 }} ₽

  <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-start;">
  <button id="pay-now" data-action="buy_order">Pay now</button>
  <button id="pay-now-intent" data-action="buy_order_intent">Pay now with PaymentIntent</button>
  </div>

  <div id="error-message" style="color: red; margin-top: 10px;"></div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const stripe = Stripe('{{ stripe_key }}');

    document.getElementById('pay-now').addEventListener('click', function () {
      fetch("{% url 'payment:buy_order' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({}),
      })
      .then(response => response.json())
      .then(data => {
        if (data.sessionId) {
          stripe.redirectToCheckout({ sessionId: data.sessionId })
            .then(function (result) {
              if (result.error) {
                document.getElementById('error-message').textContent = result.error.message;
              }
            });
        } else {
          document.getElementById('error-message').textContent = data.error || "An error occurred.";
        }
      })
      .catch(error => {
        console.error("Error:", error);
        document.getElementById('error-message').textContent = "An error occurred.";
      });
    });

    document.getElementById('pay-now-intent').addEventListener('click', function () {
      fetch("{% url 'payment:buy_order_intent' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({}),
      })
      .then(response => response.json())
      .then(data => {
        if (data.clientSecret) {
          window.location.href = "{% url 'payment:process_payment' %}?clientSecret=" + data.clientSecret;
        } else {
          document.getElementById('error-message').textContent = data.error || "An error occurred.";
        }
      })
      .catch(error => {
        console.error("Error:", error);
        document.getElementById('error-message').textContent = "An error occurred.";
      });
    });
  });
</script>
{% endblock %}